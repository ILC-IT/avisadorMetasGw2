<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>GW2 Metas Notifier</title>
    <link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="stylesheet" href="/css/estilos.css" />
</head>

<body>
    <h2>GW2 Select Metas and Timers</h2>
    <form id="form-metas">
        <div class="button-container">
            <label for="minutosAviso">‚è∞ Notify before: </label>
            <span style="display: flex; align-items: center; gap: 4px;">
                <input type="number" id="minutosAviso" min="1" max="59" value="10" />
                <span>min</span>
            </span>
            <button type="submit">üíæ Save selection</button>
            <button type="button" id="btn-borrar">üßπ Clear current selection</button>
            <button type="button" id="btn-borrar-total">üóëÔ∏è Clear all</button>
            <button type="button" id="btn-destacar">üåü Highlight upcoming metas</button>
        </div>
        <div class="meta-grid" id="checkbox-container">Loading metas...</div><br />
    </form>

    <script>
        const checkboxContainer = document.getElementById('checkbox-container');
        const form = document.getElementById('form-metas');
        const minutosAvisoInput = document.getElementById('minutosAviso');
        minutosAvisoInput.addEventListener('change', guardarSeleccion); // Con esto ya autoguarda
        let checkboxes = [];
        let seleccionGuardada = {};

        async function cargarConfiguracion() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                seleccionGuardada = config.seleccion || {};
                minutosAvisoInput.value = config.minutosAviso ?? 10;
                // Sincronizar localStorage con backend para evitar discrepancias
                localStorage.setItem('seleccionMetasHoras', JSON.stringify(seleccionGuardada));
                localStorage.setItem('minutosAviso', minutosAvisoInput.value);
            } catch (error) {
                console.warn('No se pudo cargar la configuracion del servidor.', error);
                seleccionGuardada = {};
                minutosAvisoInput.value = 10;
            }
        }

        function guardarSeleccion() {
            const seleccion = {};

            document.querySelectorAll('.meta-container').forEach(div => {
                const meta = div.dataset.meta;
                const horasSeleccionadas = [...div.querySelectorAll('input[type="checkbox"]:checked')].map(cb => cb.value);
                if (horasSeleccionadas.length > 0) {
                    seleccion[meta] = horasSeleccionadas;
                }
            });

            // Validacion de minutosAviso
            let minutosAviso = parseInt(minutosAvisoInput.value, 10);
            if (isNaN(minutosAviso) || minutosAviso < 1 || minutosAviso > 59) {
                minutosAviso = 10; // valor por defecto
                minutosAvisoInput.value = minutosAviso;
            }

            // Guardar en localStorage
            localStorage.setItem('minutosAviso', minutosAviso);
            localStorage.setItem('seleccionMetasHoras', JSON.stringify(seleccion));

            // Enviar al servidor
            fetch('/guardar-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    seleccion,
                    minutosAviso
                })
            });
        }

        async function cargarMetas() {
            try {
                const res = await fetch('/api/metas');
                const metas = await res.json();
                checkboxContainer.innerHTML = '';

                metas.forEach(meta => {
                    const div = document.createElement('div');
                    div.classList.add('meta-container');
                    div.dataset.meta = meta.nombre;

                    const titulo = document.createElement('strong');
                    titulo.textContent = meta.nombre;
                    div.appendChild(titulo);
                    div.appendChild(document.createElement('br'));

                    meta.horarios.forEach(hora => {
                        const id = `${meta.nombre}-${hora}`;
                        const label = document.createElement('label');
                        label.htmlFor = id;

                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = id;
                        input.name = `horas-${meta.nombre}`;
                        input.value = hora;

                        if (seleccionGuardada[meta.nombre]?.includes(hora)) {
                            input.checked = true;
                        }

                        input.addEventListener('change', () => { // con esto ya autoguarda
                            guardarSeleccion();
                            actualizarResaltadoMetas();
                        });

                        label.appendChild(input);
                        label.append(` ${hora}`);
                        div.appendChild(label);
                        div.appendChild(document.createElement('br'));
                        checkboxes.push(input);
                    });

                    // Boton para copiar WP
                    const btnCopiar = document.createElement('button');
                    btnCopiar.type = 'button';
                    btnCopiar.style.cursor = 'pointer';
                    btnCopiar.textContent = 'üìã Copy WP';
                    btnCopiar.addEventListener('click', () => {
                        // Solo copiar las horas seleccionadas
                        //const horasSeleccionadas = [...div.querySelectorAll('input[type="checkbox"]:checked')]
                            //.map(cb => cb.value)
                            //.join(', ') || 'Sin selecci√≥n';
                        
                        const texto = `${meta.nombre}: ${meta.puntoRuta || 'N/A'}`;

                        const textArea = document.createElement("textarea");
                        textArea.value = texto;
                        // Para que no haga scroll hacia abajo del todo
                        textArea.style.position = "fixed";
                        textArea.style.opacity = "0";
                        textArea.style.pointerEvents = "none";
                        
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();

                        /*navigator.clipboard.writeText(texto)
                            .then(() => {
                                btnCopiar.textContent = '‚úÖ Copied!';
                                setTimeout(() => btnCopiar.textContent = 'üìã Copy WP', 1500);
                            })
                            .catch(err => {
                                console.error('Copy error:', err);
                                alert('‚ùå Can not copy to clipboard.');
                            });*/
                        
                        try {
                            const success = document.execCommand('copy');
                            if (success) {
                                btnCopiar.textContent = '‚úÖ Copied!';
                                setTimeout(() => btnCopiar.textContent = 'üìã Copy WP', 1500);
                            } else {
                                alert('‚ùå Could not copy. Please press Ctrl+C to copy manually.');
                            }
                        } catch (err) {
                            console.error('Copy error:', err);
                            alert('‚ùå Copy not supported on this browser.');
                        }
                        document.body.removeChild(textArea);
                    });

                    div.appendChild(btnCopiar);

                    // Para borrar solo la seleccion de cada meta
                    const btnBorrarMeta = document.createElement('button');
                    btnBorrarMeta.type = 'button';
                    btnBorrarMeta.style.cursor = 'pointer';
                    btnBorrarMeta.textContent = 'üóëÔ∏è Clear this meta';
                    btnBorrarMeta.addEventListener('click', () => {
                        // Desmarcar todos los checkboxes de este meta
                        div.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                        guardarSeleccion();
                        actualizarResaltadoMetas();
                        alert(`‚úÖ Cleared meta: ${meta.nombre}`);
                    });

                    div.appendChild(document.createElement('br'));
                    div.appendChild(btnBorrarMeta);

                    checkboxContainer.appendChild(div);
                    checkboxContainer.appendChild(document.createElement('hr'));
                });

                actualizarResaltadoMetas();

            } catch (error) {
                checkboxContainer.innerHTML = '‚ùå Error loading metas.';
                console.error(error);
            }
        }

        const btnBorrar = document.getElementById('btn-borrar');
        btnBorrar.title = "Clear the current selection of all metas";
        btnBorrar.addEventListener('click', () => {
            checkboxes.forEach(cb => cb.checked = false);
            guardarSeleccion();
            actualizarResaltadoMetas();
            alert("‚úÖ Current selection has been cleared.");
        });

        const btnBorrarTotal = document.getElementById('btn-borrar-total');
        btnBorrarTotal.title = "Clear the current selection of all metas and sets notify before 10 minutes";
        btnBorrarTotal.addEventListener('click', () => {
            checkboxes.forEach(cb => cb.checked = false);
            minutosAvisoInput.value = 10; // valor por defecto
            guardarSeleccion();
            actualizarResaltadoMetas();
            alert("‚úÖ ALL selections have been cleared.");
        });

        let modoDestacadoActivo = false; // para saber si el modo highlight esta activo
        const margenMin = -5; // minutos antes (si es negativo) de la hora actual
        const margenMax = 30; // minutos despues de la hora actual, no puede ser menor al margen minimo

        document.getElementById('btn-destacar').addEventListener('click', destacarHorasProximas);

        function actualizarTextoBoton() {
            const boton = document.getElementById('btn-destacar');
            if (modoDestacadoActivo) {
                boton.textContent = '‚ùå Remove highlights';
            } else {
                boton.textContent = `üåü Manual highlight upcoming metas`;
                const ahora = new Date();
                // Crear las fechas de inicio y fin segun los rangos
                const inicio = new Date(ahora.getTime() + margenMin * 60 * 1000);
                const fin = new Date(ahora.getTime() + margenMax * 60 * 1000);
                let textoRango;
                if (margenMin < 0) {
                    textoRango = `Range: from ${formatearHora(inicio)} (${margenMin} min before now) to ${formatearHora(fin)} (+${margenMax} min after now)`;
                } else {
                    textoRango = `Range: from ${formatearHora(inicio)} (now +${margenMin} min) to ${formatearHora(fin)} (now +${margenMax} min)`;
                }
                boton.title = textoRango;
            }
        }

        // Formatear la hora (HH:MM)
        function formatearHora(fecha) {
            return fecha.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Para destacar horas
        function destacarHorasProximas() {
            const boton = document.getElementById('btn-destacar');

            // Si ya esta activo, quitar resaltado
            if (modoDestacadoActivo) {
                document.querySelectorAll('label.destacado')
                    .forEach(lbl => lbl.classList.remove('destacado'));
                modoDestacadoActivo = false;
                actualizarTextoBoton();
                return;
            }

            // Activar modo resaltado
            modoDestacadoActivo = true;
            actualizarTextoBoton();

            const ahora = new Date();
            const minutosActuales = ahora.getHours() * 60 + ahora.getMinutes();

            // Quitar resaltados anteriores por si acaso
            document.querySelectorAll('label.destacado')
                .forEach(lbl => lbl.classList.remove('destacado'));

            // Detectar si el margenMin es negativo (modo bidireccional)
            const modoBidireccional = margenMin < 0;

            // Revisar todas las horas (labels)
            document.querySelectorAll('.meta-container label').forEach(label => {
                const hora = label.textContent.trim();
                const match = hora.match(/^(\d{2}):(\d{2})$/);

                if (!match) return; // evitar que falle si el label tiene otro texto

                const [_, h, m] = match.map(Number);
                const minutosEvento = h * 60 + m;

                let diff = minutosEvento - minutosActuales;

                if (modoBidireccional) {
                    // Permite margenes negativos y positivos (¬±12h)
                    if (diff > 720) diff -= 1440;
                    if (diff < -720) diff += 1440;
                } else {
                    // Solo futuros (ajuste simple a 0‚Äì24h)
                    if (diff < 0) diff += 1440; // si ya paso, cuenta como del dia siguiente
                }

                if (diff >= margenMin && diff <= margenMax) {
                    label.classList.add('destacado');
                }
            });
        }

        function actualizarResaltadoMetas() {
            document.querySelectorAll('.meta-container').forEach(div => {
                const titulo = div.querySelector('strong');
                const algunMarcado = div.querySelector('input[type="checkbox"]:checked') !== null;

                if (algunMarcado) {
                    titulo.classList.add('meta-selected');
                } else {
                    titulo.classList.remove('meta-selected');
                }
            });
        }

        form.addEventListener('submit', e => {
            e.preventDefault();
            guardarSeleccion();
            actualizarResaltadoMetas();
            alert("‚úÖ Selection saved.");
        });

        async function iniciarApp() {
            await cargarConfiguracion();
            await cargarMetas();
        }

        actualizarTextoBoton();
        iniciarApp();
        
    </script>
</body>

</html>